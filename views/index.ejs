<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/stylesheets/style.css">
    <script src="https://cdn.tailwindcss.com"></script>    
    <title>Document</title>
</head>
<body class=" bg-cyan-600 flex items-center justify-center relative">
    <div class="chatpannel bg-white rounded-md w-fit p-4 ">
        <form id="startChat">
            <label for="username" class="text-2xl">name:</label>
            <input type="text" id="username" autocomplete="off" class="border-2 " name="username" required>
            <button class=" startbtn bg-blue-600 px-3 py-1 rounded-md text-white" type="submit">Start</button>
        </form>

    </div>
    <div class="chatRoom h-[80%] w-[70%] rounded-md bg-white overflow-hidden relative shadow-cyan-800 shadow-xl hidden">
        <div class="chatRoom-inner flex relative h-full w-full">
            <div class="profile h-full w-[25%] bg-cyan-700 flex flex-col items-center p-4">
                <div class="image h-[10vw] w-[10vw] bg-gray-400 rounded-full"></div>
                <h2 class="user text-white text-xl mt-4">user name</h2>
            </div>
            <div class="chat w-[75%] h-full bg-gray-200 relative flex flex-col">
                <div class="nav w-full h-14 bg-white p-3 flex justify-between items-center">
                    <h1 class="text-[2vw] text-left capitalize">Chat Room</h1>
                    <h1 id="typing" class="hidden"><span id="typer">someone</span> is typing...</h1>

                    <div id="user-list" class="bg-white p-2 rounded-md shadow-lg flex flex-col gap-4">
                        <h2 class="text-sm font-bold text-center">Users Online (<span id="user-count" class="cursor-pointer">0</span>)</h2>
                        <ul id="usernames" class="mt-2 hidden absolute top-10 right-0 px-4 text-center bg-white border border-gray-300 rounded-md shadow-lg">
                            <!-- Usernames will be dynamically inserted here -->
                        </ul>
                    </div>

                </div>
                <div id="messages" class="messages flex-grow overflow-y-auto p-4 space-y-2 custom-scrollbar">
                    
                </div>
                <form id="chat-form" class="chat-form flex p-2 gap-2">
                    <input type="text" id="message-input" class="flex-grow p-2 border border-gray-300 rounded-l" placeholder="Type your message..." autocomplete="off" required>
                    <button type="submit" class="bg-blue-500 text-white p-2 rounded">Send</button>
                </form>
            </div>
        </div>
        
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO" crossorigin="anonymous"></script>
    <script>

        
            const username = document.querySelector("#username");
            const startBtn = document.querySelector("#startChat");
            const userCount = document.getElementById('user-count');
            const usernames = document.getElementById('usernames');
            const messages = document.getElementById('messages');
            const input = document.getElementById('message-input');
            const form = document.getElementById('chat-form');
            const typing = document.getElementById('typing');
            const typer = document.getElementById('typer');
            

            let typingTimeout;
            
            startBtn.addEventListener("submit",function(e){
                e.preventDefault();
             if(username.value.trim().length>0){
                document.querySelector(".chatpannel").classList.add("hidden");
                document.querySelector(".chatRoom").classList.remove("hidden");
                document.querySelector(".chatRoom h2").textContent = username.value;
             }
             else alert("Please enter a valid username!");

             userCount.addEventListener('click', function() {
    
    // Toggle the visibility of the usernames list
    if (usernames.classList.contains('hidden')) {
        usernames.classList.remove('hidden');
    } else {
        usernames.classList.add('hidden');
    }
});

        const socket =io();
        socket.emit("new user",username);
     
socket.on('user-list', function(users) {
    userCount.textContent = users.length;
    usernames.innerHTML = '';
    

users.forEach(user => {
    const li = document.createElement('li');
    li.textContent = user.newuser;
    li.className = 'text-blue-500 hover:text-blue-700 h-auto';
    li.dataset.userId = user.id; 
    usernames.appendChild(li);
});
    input.addEventListener('input', () => {
    socket.emit('typing', username); 
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
    socket.emit('stop typing');
    }, 1000);
});
     socket.on('typing', (username) => {
     typer.textContent = `${username} `;
     typing.classList.remove('hidden');
});  

socket.on('stop typing', () => {
    typing.classList.add('hidden');
});
});
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
            socket.emit('chat message', input.value); 
            input.value = ''; 
        }
    });

    socket.on('chat message', function(data) {
    const msgDiv = document.createElement('div'); 

    if (socket.id === data.userId) {
        msgDiv.className = 'msg ml-auto w-fit bg-blue-500 text-white px-2 py-1 rounded-md';
        msgDiv.innerHTML = `<span class="user font-bold">You: </span>${data.message}`;
    } else {
        msgDiv.className = 'msg self-start w-fit bg-gray-300 text-black px-2 py-1 rounded-md';
        msgDiv.innerHTML = `<span class="user font-bold">${data.username}: </span>${data.message}`;
    }
    messages.appendChild(msgDiv);
    messages.scrollTop = messages.scrollHeight; // Auto-scroll to the latest message   
});
})
    </script>
</body>
</html>